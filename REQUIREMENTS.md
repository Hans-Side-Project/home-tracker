# 房貸試算器 - 功能需求文件

## 專案概述

### 產品願景

建立一個功能完整的房貸試算器 Web 應用程式，幫助使用者快速計算房貸相關資訊，包含本息攤還、利息費用、提前還款等功能。

### 技術架構概述

- **前端框架**: Blazor Server (.NET 8)
- **後端**: ASP.NET Core 8
- **部署平台**: 待定 (建議 Azure App Service 或 Docker)
- **資料庫**: 暫不需要 (純計算功能)

## 功能需求

### 1. 基本房貸試算功能

#### 1.1 貸款基本資訊輸入

**輸入欄位設計**:

- 🏠 **房屋總價** (新台幣)
- 💰 **自備款金額** (新台幣)
- 💰 **貸款條件設定** (智能切換模式)：
  - **模式一：以貸款成數為主**
    - 📊 **貸款成數** (可編輯，預設80%)
    - 💳 **貸款金額** (自動計算，僅顯示)
  - **模式二：以貸款金額為主**
    - 💳 **貸款金額** (可編輯，新台幣)
    - 📊 **貸款成數** (自動計算，僅顯示)
  - 🔄 **模式切換按鈕** (在兩種模式間切換)
- ⏰ **貸款年限** (1-40年，預設30年)
- 📈 **利率設定** (智能切換模式)：
  - **模式一：固定利率**
    - 📊 **固定年利率** (可編輯，0.1%-20%，預設2.5%)
    - 📉 **月利率** (自動計算，僅顯示)
  - **模式二：階段式利率**
    - 📊 **利率階段列表** (動態可增減)
      - 📈 **階段年利率** (可編輯，0.1%-20%)
      - 📉 **階段月利率** (自動計算，僅顯示)
      - ⏰ **階段年限** (可編輯，1年-剩餘年限)
      - ➕ **新增階段按鈕**
      - ➖ **刪除階段按鈕** (至少保留一個階段)
    - ⚠️ **階段驗證提示** (總年限不可超過貸款年限)
  - 🎛️ **利率模式切換按鈕** (在固定/階段式模式間切換)
- ⏳ **寬限期設定** (智能切換模式)：
  - **模式一：無寬限期**
    - 💫 **直接進入正常還款期** (預設選項)
  - **模式二：有寬限期**
    - ⏳ **寬限期年限** (可編輯，1-5年)
    - ⚙️ **寬限期計算方式** (選項)：是否包含在貸款年限內
  - 🔄 **寬限期模式切換按鈕** (在無寬限期/有寬限期模式間切換)
- 📋 **雜支費用** (新台幣) - 如代書費、規費等
- 🎨 **裝潢費用** (新台幣) - 額外裝修預算

**互動邏輯需求**:

- **智能切換模式機制**：
  - 🔄 提供切換按鈕，讓使用者選擇編輯模式
  - 💡 預設為「貸款成數模式」(較常用的輸入方式)
  - 🎯 切換時保持計算結果的一致性

- **貸款成數模式 (模式一)**：
  - 當使用者編輯貸款成數時，自動計算並更新貸款金額
  - 貸款金額以 label 形式顯示，不可編輯，有明顯的視覺區別
  - 計算公式：貸款金額 = (房屋總價 - 自備款) × 貸款成數

- **貸款金額模式 (模式二)**：
  - 當使用者編輯貸款金額時，自動計算並更新貸款成數
  - 貸款成數以 label 形式顯示，不可編輯，有明顯的視覺區別
  - 計算公式：貸款成數 = 貸款金額 ÷ (房屋總價 - 自備款)

- **通用聯動邏輯**：
  - 當房屋總價或自備款變更時，重新計算非編輯狀態的欄位
  - 年利率變更時，自動計算並顯示月利率 (年利率 ÷ 12)

- **寬限期智能切換模式**：
  - 🔄 提供切換按鈕，讓使用者選擇是否使用寬限期
  - 💡 預設為「無寬限期模式」(直接正常還款)
  - 🎯 切換到「有寬限期模式」時，顯示寬限期相關設定欄位
  - 📊 寬限期設定影響總還款期數和月付金計算

- **無寬限期模式 (模式一)**：
  - 直接進入正常還款期，無需額外設定
  - 隱藏所有寬限期相關輸入欄位
  - 從第一個月開始正常本息攤還

- **有寬限期模式 (模式二)**：
  - 顯示寬限期年限輸入欄位 (1-5年)
  - 顯示寬限期計算方式選項 (是否包含在貸款年限內)
  - 寬限期內僅支付利息，本金不攤還
  - 寬限期結束後開始正常本息攤還

#### 1.2 還款方式選擇

**支援的還款方式**:

- **本息攤還**: 每月固定金額還款
  - 自動計算每月還款金額
  - 顯示每三年一個級距的還款明細表
  - 分別顯示每期的本金與利息金額

- **本金攤還**: 每月本金固定，利息遞減
  - 自動計算每月還款金額 (首月最高，逐月遞減)
  - 顯示每三年一個級距的還款明細表
  - 分別顯示每期的本金與利息金額

- **只繳利息**: 寬限期內只繳利息

**還款明細表格式**:

- 年度區間 (如: 第1-3年、第4-6年...)
- 每月還款金額
- 本金金額
- 利息金額
- 本金利息比例

#### 1.3 計算結果顯示

**主要結果顯示項目**:

- 💳 **貸款總金額**
- 💰 **初始資金金額** (自備款 + 雜支費用 + 裝潢費用)
- 💸 **每月還款金額**
- 📊 **總利息費用**
- 💵 **總還款金額**
- 🏷️ **總投資成本** (房屋總價 + 雜支費用 + 裝潢費用)
- 📋 **每三年期間還款明細表**
- ⏳ **寬限期還款詳情** (如適用)

##### 1.3.1 寬限期還款詳情計算

**顯示條件**: 僅當寬限期月數 > 0 時顯示

**寬限期期間顯示內容**:

- 寬限期月數
- 寬限期每月還款金額 (僅利息)
- 寬限期總利息支出
- 寬限期結束後剩餘本金 (等於原貸款金額)

**寬限期結束後資訊**:

- 寬限期後實際還款年限
- 寬限期後每月還款金額
- 寬限期後總利息費用
- 月付金增加金額 (寬限期後月付金 - 寬限期月付金)
- 月付金增加比例

**總體影響分析**:

- 總利息增加金額 (相較於無寬限期)
- 總還款期間 (寬限期 + 實際還款期間)
- 現金流影響分析

### 4.4 輸入驗證與錯誤處理

系統將提供利率模式智能切換功能，消除用戶在固定利率與浮動利率之間的輸入困擾。

#### 4.3.1 利率模式切換需求

#### 功能需求 FR-21：利率模式選擇

- 系統應提供利率模式切換功能，包含固定利率和階段式利率兩種模式
- 切換按鈕應清楚標示當前選擇的模式
- 切換時應保留已輸入的相關數值
- 預設選擇固定利率模式

#### 功能需求 FR-22：固定利率模式

- 當選擇固定利率模式時，系統應：
  - 顯示單一年利率輸入欄位
  - 自動計算並顯示對應的月利率
  - 隱藏浮動利率相關欄位
  - 使用固定利率進行所有貸款計算

#### 功能需求 FR-23：階段式利率模式

- 當選擇階段式利率模式時，系統應：
  - 顯示動態階段列表，每個階段包含年利率和年限輸入欄位
  - 提供「新增階段」按鈕以增加新的利率階段
  - 提供「刪除階段」按鈕以移除指定階段（最少保留一個階段）
  - 即時顯示所有階段年限總和，並與貸款年限進行比較
  - 每個階段自動計算並顯示對應的月利率
  - 隱藏固定利率相關欄位
  - 使用多階段利率進行貸款計算

#### 功能需求 FR-24：利率驗證規則

- 所有利率輸入應在 0.1% 至 20% 之間
- 階段式利率模式驗證規則：
  - 每個階段的年限必須大於 0
  - 所有階段年限總和必須等於貸款年限
  - 最少須設定一個階段，最多可設定10個階段
  - 當貸款年限改變時，應重新驗證所有階段年限總和
  - 提供自動調整功能：當總和不等於貸款年限時，建議調整方案

#### 4.3.2 利率計算邏輯

#### 功能需求 FR-25：固定利率計算

- 使用單一年利率進行整個貸款期間的計算
- 月利率 = 年利率 ÷ 12
- 每月還款金額在整個貸款期間保持固定

#### 功能需求 FR-26：階段式利率計算

- 支援多階段利率設定，每個階段包含：
  - 階段年利率：該階段適用的年利率
  - 階段月利率：該階段年利率對應的月利率 (年利率 ÷ 12)
  - 階段年限：該階段持續的年數
- 階段管理功能：
  - 使用者可動態新增或刪除利率階段
  - 最少須設定一個階段，最多可設定10個階段
  - 所有階段年限總和必須等於貸款年限
- 階段式利率計算：
  - 依序按階段計算各期間的還款金額
- 每月還款金額會在每個階段開始時重新計算

#### 4.3.3 寬限期模式切換需求

#### 功能需求 FR-27：寬限期模式選擇

- 系統應提供寬限期模式切換功能，包含無寬限期和有寬限期兩種模式
- 切換按鈕應清楚標示當前選擇的模式
- 切換時應保留已輸入的相關數值
- 預設選擇無寬限期模式

#### 功能需求 FR-28：無寬限期模式

- 當選擇無寬限期模式時，系統應：
  - 隱藏所有寬限期相關輸入欄位
  - 從第一期開始進行正常本息攤還
  - 使用完整的貸款年限進行計算
  - 不顯示寬限期相關的計算結果

#### 功能需求 FR-29：有寬限期模式

- 當選擇有寬限期模式時，系統應：
  - 顯示寬限期年限輸入欄位（1-5年）
  - 顯示寬限期計算方式選項（是否包含在貸款年限內）
  - 在寬限期內僅計算利息支付，不攤還本金
  - 寬限期結束後開始正常本息攤還
  - 顯示寬限期相關的詳細計算結果

#### 功能需求 FR-30：寬限期驗證規則

- 寬限期年限輸入應在 1 至 5 年之間
- 寬限期驗證規則：
  - 寬限期年限不可超過貸款年限
  - 當選擇「包含在貸款年限內」時，實際還款年限 = 貸款年限 - 寬限期
  - 當選擇「不包含在貸款年限內」時，總還款期間 = 貸款年限 + 寬限期
  - 提供寬限期對總還款成本影響的警示資訊

##### 1.4.1 輸入驗證規則

**數值範圍驗證**:

- **房屋總價**: 100萬 ~ 1億新台幣
- **自備款**: 0 ~ 房屋總價
- **貸款金額**: 10萬 ~ 8,000萬新台幣
- **貸款成數**: 10% ~ 90%
- **年利率**: 0.1% ~ 20%
- **貸款年限**: 1年 ~ 40年
- **寬限期**: 0年 ~ 5年
- **雜支費用**: 0 ~ 1,000萬新台幣
- **裝潢費用**: 0 ~ 5,000萬新台幣

**數值精度控制**:

- **金額欄位**: 精確到新台幣元 (小數點後0位)
- **利率欄位**: 精確到小數點後3位 (0.001%)
- **百分比欄位**: 精確到小數點後1位 (0.1%)

**輸入格式需求**:

- 僅允許數字輸入，自動過濾非數字字元
- 支援千分位逗號顯示 (如: 1,000,000)
- 利率輸入支援百分比符號自動轉換

##### 1.4.2 邏輯一致性驗證

**貸款條件邏輯檢查**:

- **智能切換模式驗證**：
  - 在貸款金額模式下：貸款金額不可超過 (房屋總價 - 自備款)
  - 在貸款成數模式下：計算出的貸款金額不可超過 (房屋總價 - 自備款)
  - 自備款 + 貸款金額必須等於房屋總價
  - 模式切換時保持計算結果的合理性與一致性
- 寬限期不可超過貸款年限

**模式切換驗證規則**:

- 切換前驗證當前模式輸入值的有效性
- 切換後驗證計算結果是否在合理範圍內
- 如計算結果超出範圍，自動調整或提供修正建議
- 確保兩種模式下的計算結果完全一致

**財務合理性檢查**:

- 總投資成本 (房價 + 雜支 + 裝潢) 不可超過合理上限
- 每月還款金額不可超過合理收入比例 (提供警示)
- 貸款金額與年收入比例檢查 (提供建議)

**邊界條件處理**:

- 極小利率 (< 0.5%) 時的計算穩定性檢查
- 極長年限 (> 35年) 時的總利息警示
- 高貸款成數 (> 85%) 時的風險提醒

##### 1.4.3 錯誤訊息與使用者引導

**錯誤訊息分級**:

- **錯誤 (Error)**: 阻止計算執行，必須修正
  - "貸款金額不可超過房屋總價"
  - "年利率須介於 0.1% 至 20% 之間"
- **警告 (Warning)**: 可執行但有風險，建議檢視
  - "貸款成數偏高 (>80%)，建議評估風險"
  - "每月還款負擔可能過重，建議調整條件"
- **提醒 (Info)**: 資訊性提示，協助決策
  - "建議自備款至少為房價 20%"
  - "寬限期結束後月付金將增加"

**智慧錯誤修正建議**:

- 自動建議合理的輸入值範圍
- 提供快速修正按鈕 (如: "調整為最大可貸金額")
- 連動欄位自動修正提示
- 相似案例參考建議

**即時計算狀態顯示**:

- 計算進行中的載入指示器
- 輸入變更後的即時重算提示
- 資料驗證通過的視覺回饋 (綠色勾號)
- 錯誤狀態的明確標示 (紅色邊框 + 錯誤圖示)

### 2. 進階功能

#### 2.1 多種利率情境分析

- 浮動利率試算
- 階梯式利率 (如政府優惠房貸)
- 利率敏感度分析

#### 2.2 房貸比較功能

- 同時比較多個貸款方案
- 各銀行利率比較表

### 3. 使用者體驗功能

#### 3.1 輸入驗證

- 即時輸入驗證
- 合理範圍檢查
- 錯誤訊息顯示

#### 3.2 計算結果視覺化

- 本息比例圓餅圖
- 每月還款趨勢圖
- 累計還款進度圖

#### 3.3 結果匯出

- PDF 報告匯出
- Excel 試算表匯出
- 分享連結功能

## 非功能性需求

### 效能需求

- 計算回應時間 < 1秒
- 頁面載入時間 < 3秒
- 支援並發使用者數 > 100

### 相容性需求

- 支援現代瀏覽器 (Chrome, Firefox, Safari, Edge)
- 響應式設計，支援手機/平板
- 支援 PWA (漸進式網路應用程式)

### 安全性需求

- HTTPS 加密傳輸
- 輸入資料驗證
- XSS/CSRF 防護

### 可用性需求

- 直觀的使用者介面
- 清楚的操作指引
- 錯誤處理與提示

## 驗收標準

### 基本功能驗收

- [ ] 所有輸入欄位正常運作，包含圖示顯示
- [ ] **智能切換模式功能正常**：
  - [ ] 貸款條件模式切換按鈕響應正確
  - [ ] 貸款成數模式：成數可編輯，金額自動計算並以 label 顯示
  - [ ] 貸款金額模式：金額可編輯，成數自動計算並以 label 顯示
  - [ ] 貸款條件模式切換時計算結果保持一致性
  - [ ] 利率設定模式切換正常：統一利率與階段利率模式互換正確
  - [ ] 寬限期模式切換正常：無寬限期與有寬限期模式互換正確
  - [ ] 切換時的視覺狀態變化清楚明確
- [ ] 年利率與月利率自動換算正確
- [ ] 本息攤還計算公式正確實作
- [ ] 寬限期計算邏輯正確實作
- [ ] 每三年還款明細正確產生

### 資料驗證驗收

- [ ] 所有數值範圍驗證正常運作
- [ ] **智能切換模式驗證**：
  - [ ] 貸款條件兩種模式下的計算結果完全一致
  - [ ] 利率設定兩種模式下的計算結果完全一致
  - [ ] 寬限期兩種模式下的計算結果完全一致
  - [ ] 模式切換前後的驗證規則正確執行
  - [ ] 邊界條件處理 (如除零、超出範圍) 正常
  - [ ] 錯誤狀態在模式切換時正確更新
- [ ] 邏輯一致性檢查正確執行
- [ ] 錯誤訊息分級正確顯示
- [ ] 智慧修正建議功能正常

### 使用者體驗驗收

- [ ] 響應式設計在各裝置正常顯示
- [ ] **智能切換介面體驗**：
  - [ ] 所有切換按鈕在手機/平板上易於操作
  - [ ] 貸款條件切換介面響應式設計正常
  - [ ] 利率設定切換介面響應式設計正常
  - [ ] 寬限期切換介面響應式設計正常
  - [ ] 計算結果顯示區域在小螢幕上排版正確
  - [ ] 模式切換動畫流暢自然
  - [ ] 非編輯欄位的視覺區別清楚 (label 樣式)
- [ ] 計算回應時間符合效能需求
- [ ] 錯誤狀態視覺回饋清楚明確
- [ ] 即時驗證功能流暢運作

---

*此文件定義房貸試算器的功能需求，技術實作細節請參考 [TECHNICAL_SPEC.md](./TECHNICAL_SPEC.md)*
